# 자체 제작한 운영체제를 예뮬레이터로 실행

### 사전 세팅
https://www.qemu.org/download/#windows

MSYS2 설치
MSYS2 실행
pacman -S mingw-w64-x86_64-qemu
pacman -Ql mingw-w64-x86_64-nasm
echo 'export PATH=/mingw64/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
pacman -S vim

### MSYS2 환경에서 붙여넣기
shift + insert

### bootloader.asm
[BITS 16]               ; CPU를 16비트 리얼 모드로 설정하여 실행
[ORG 0x7C00]            ; 코드가 메모리의 0x7C00 주소에서 시작되도록 설정

start:
    MOV AH, 0x0E        ; BIOS 텍스트 출력 서비스 호출 준비 (0x0E: 텍스트 출력)
    MOV AL, 'H'         ; ASCII 문자 'H'를 AL 레지스터에 저장
    INT 0x10            ; BIOS 인터럽트 호출로 'H'를 화면에 출력
    MOV AL, 'e'         ; ASCII 문자 'e'를 AL 레지스터에 저장
    INT 0x10            ; BIOS 인터럽트 호출로 'e'를 화면에 출력
    MOV AL, 'l'         ; ASCII 문자 'l'를 AL 레지스터에 저장
    INT 0x10            ; BIOS 인터럽트 호출로 'l'를 화면에 출력
    MOV AL, 'l'         ; ASCII 문자 'l'를 다시 AL 레지스터에 저장
    INT 0x10            ; BIOS 인터럽트 호출로 'l'를 화면에 출력
    MOV AL, 'o'         ; ASCII 문자 'o'를 AL 레지스터에 저장
    INT 0x10            ; BIOS 인터럽트 호출로 'o'를 화면에 출력

    JMP $               ; 프로그램 실행을 멈추고 현재 위치에서 무한 루프

times 510-($-$$) db 0    ; 부트 섹터 크기를 512바이트로 맞추기 위해 빈 공간을 0으로 채움
db 0x55, 0xAA            ; 부트 섹터 서명(0x55AA) 추가, BIOS가 부팅 가능한 디스크로 인식하기 위함

### 컴파일
nasm -f bin bootloader.asm -o bootloader.bin

### 실행
qemu-system-x86_64 -drive format=raw,file=bootloader.bin

### 원리
메인보드에 내장된 프로그램 BIOS가 부팅 디스크로 설정된 디스크의 첫 섹터(512바이트)를 읽는다. 이 첫 섹터는 512바이트고 부트 섹터라고도 한다.
바이오스는 이 섹터의 내용을 메모리의 0x7c00 주소로 로드한다
CPU의 실행 시작 지점은 부트 섹터의 첫 번째 명령어로 설정된다
부트 섹터의 코드는 부트로더로서 작동하며, 이후 시스템 초기화 또는 운영 체제 로드가 진행된다.

### 0x7c00의 의미
네, 0x7C00은 부팅 프로세스에서 특별한 의미를 갖는 주소입니다. 이는 BIOS가 부트 섹터를 메모리로 로드하는 표준 주소로 지정되어 있기 때문입니다.

1. BIOS 표준 로드 주소
BIOS는 부트 디스크의 첫 섹터(부트 섹터, 512바이트)를 메모리의 0x7C00 주소에 로드하도록 설계되어 있습니다.

이는 PC 호환 BIOS의 표준 규격으로, 부트 로더가 항상 같은 메모리 위치에서 실행될 수 있도록 보장합니다.

2. 역사적 이유
초기 IBM PC에서 메모리 주소 0x0000부터 특정 영역은 BIOS와 하드웨어에 의해 사용되었습니다.

예: 0x0000~0x03FF는 인터럽트 벡터 테이블(IVT)에 사용.

0x0400~0x7BFF는 BIOS 데이터와 기타 하드웨어 사용.

부트로더가 로드될 주소를 결정할 때, 이와 겹치지 않는 안전한 메모리 영역으로 0x7C00가 선택되었습니다.

3. 부트로더 실행의 관점
부트로더가 0x7C00에 로드되기 때문에 부트로더 작성 시 이를 고려하여 메모리 주소를 설정해야 합니다.

NASM 코드에서 ORG 0x7C00는 코드가 이 주소에서 실행된다는 것을 명시합니다.

만약 다른 주소를 사용하려 한다면, BIOS 표준과 맞지 않아 제대로 실행되지 않을 가능성이 있습니다.

4. 호환성과 현대 시스템
UEFI(현대 펌웨어)는 BIOS를 대체하고 더 정교한 부팅 메커니즘을 제공합니다. 하지만, BIOS 호환 모드(레거시 모드)에서는 여전히 0x7C00을 부트 섹터의 로드 주소로 사용합니다.

정리
0x7C00은 BIOS가 부트 섹터를 메모리에 로드하는 기준 위치로, 역사적 관례와 호환성을 유지하기 위한 중요한 표준 주소입니다. 그래서 우리가 작성한 부트로더도 이 주소를 기준으로 설계됨

### cpu에서 처음 실행하는 코드
바이오스에 의해서 각 하드웨어가 초기화되고
실행할 코드의 위치를 짚어준다


BIOS는 실행 중에 CPU의 레지스터를 변경하는 명령어를 실행합니다.
예를 들어, 어셈블리 언어에서는 MOV 명령어를 사용하여 특정 값(예: CS: 0x7C0, IP: 0x0000)을 레지스터에 저장합니다.

CS:IP 설정의 예:
asm
MOV CS, 0x7C0    ; 코드 세그먼트를 0x7C0으로 설정
MOV IP, 0x0000   ; 오프셋을 0x0000으로 설정
이러한 명령어를 실행하면 CPU는 CS:IP 레지스터를 업데이트하고, 설정된 메모리 주소(물리 주소 0x7C00)에서 실행을 시작합니다.
